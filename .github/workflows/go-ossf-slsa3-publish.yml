name: Build and Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0)'
        required: true
        default: '1.0.0'
  
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true
    
    - name: Validate version format
      run: |
        if ! [[ "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format X.Y.Z"
          exit 1
        fi
    
    - name: Check if tag already exists
      run: |
        if git rev-parse "v${{ github.event.inputs.version }}" >/dev/null 2>&1; then
          echo "Error: Tag v${{ github.event.inputs.version }} already exists"
          exit 1
        fi
    
    - name: Initialize Go module and get dependencies
      run: |
        go mod init nx-app || true
        go get github.com/shirou/gopsutil/v3/mem@v3.24.5 
        go get github.com/shirou/gopsutil/v3/process 
        go get github.com/shirou/gopsutil/v3/cpu 
        go get github.com/shirou/gopsutil/v3/host
        go mod tidy
    
    - name: Run tests
      run: go test ./... -v
      continue-on-error: false
    
    - name: Build for multiple platforms with static linking
      run: |
        mkdir -p ./release
        
        # Define version and build info
        VERSION="${{ github.event.inputs.version }}"
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT_SHA=$(git rev-parse --short HEAD)
        LDFLAGS="-s -w -extldflags=-static -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.CommitSHA=${COMMIT_SHA}"
        
        # Build Windows AMD64
        echo "Building for Windows AMD64..."
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="${LDFLAGS}" -o ./release/nx-app-windows-amd64.exe main.go
        
        chmod +x ./release/*
    
    - name: Generate checksums
      run: |
        cd ./release
        sha256sum * > checksums.txt
        cat checksums.txt
    
    - name: Create compressed archives
      run: |
        cd ./release
        # Create zip archive for Windows
        zip nx-app-windows-amd64.zip nx-app-windows-amd64.exe
        ls -lh
    
    - name: Generate release notes
      id: release_notes
      run: |
        cat << EOF > release_notes.md
        ## Release v${{ github.event.inputs.version }}
        
        ### Changes
        - Built from commit: \`$(git rev-parse --short HEAD)\`
        - Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ### Downloads
        Choose the appropriate binary for your platform:
        - **Windows AMD64**: \`nx-app-windows-amd64.zip\`
        
        ### Installation
        
        #### Windows
        \`\`\`powershell
        # Download and extract
        Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/v${{ github.event.inputs.version }}/nx-app-windows-amd64.zip" -OutFile "nx-app-windows-amd64.zip"
        Expand-Archive -Path nx-app-windows-amd64.zip -DestinationPath .
        
        # Run the application
        .\nx-app-windows-amd64.exe
        \`\`\`
        
        ### Verify checksums
        \`\`\`bash
        sha256sum -c checksums.txt
        \`\`\`
        EOF
        
        cat release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: Release v${{ github.event.inputs.version }}
        tag_name: v${{ github.event.inputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ./release/*.zip
          ./release/checksums.txt
        make_latest: true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-v${{ github.event.inputs.version }}
        path: ./release/
        retention-days: 30
