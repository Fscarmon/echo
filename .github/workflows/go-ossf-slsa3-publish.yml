name: Build and Release (ECH Support)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0-ech)'
        required: true
        default: '1.0.0-ech'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential
    
    # --- ç¼“å­˜ 1: Go æ¨¡å—å’Œæ„å»ºç¼“å­˜ ---
    - name: Cache Go modules and build cache
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-mod-v1
        restore-keys: |
          ${{ runner.os }}-go-mod-
    
    # --- å…³é”®ï¼šè®¾ç½® Go å¼•å¯¼ç¯å¢ƒï¼ˆç”¨äºç¼–è¯‘ Cloudflare Goï¼‰---
    - name: Set up Go 1.22 for Cloudflare Go Bootstrap
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        cache: false 
    # -----------------------------------

    # --- ç¼“å­˜ 2: Cloudflare Go ç¼–è¯‘å™¨ ---
    - name: Cache Cloudflare Go Toolchain
      id: cache-cf-go
      uses: actions/cache@v4
      with:
        path: /tmp/cf-go
        key: cf-go-toolchain-${{ runner.os }}-v2 # ç¡®ä¿æ¸…é™¤æ—§ç¼“å­˜
        restore-keys: |
          cf-go-toolchain-${{ runner.os }}-
    
    - name: Clone and build Cloudflare Go
      if: steps.cache-cf-go.outputs.cache-hit != 'true'
      run: |
        echo "Cache miss: Building Cloudflare Go from source..."
        
        # ä¿®å¤å¼•å¯¼é”™è¯¯ï¼šè®¾ç½®æ­£ç¡®çš„å¼•å¯¼è·¯å¾„
        export GOROOT_BOOTSTRAP=$(go env GOROOT)
        echo "Using GOROOT_BOOTSTRAP: $GOROOT_BOOTSTRAP"
        
        git clone https://github.com/cloudflare/go.git /tmp/cf-go
        cd /tmp/cf-go
        git checkout cf
        cd src
        # ä½¿ç”¨å¼•å¯¼è·¯å¾„è¿›è¡Œç¼–è¯‘
        ./make.bash
    
    - name: Verify Cloudflare Go
      run: |
        if [ ! -f "/tmp/cf-go/bin/go" ]; then
          echo "Error: Cloudflare Go binary not found! Build failed or cache issue."
          exit 1
        fi
        /tmp/cf-go/bin/go version
        echo "Cloudflare Go is ready."
    
    # --- å…³é”®ï¼šç§»é™¤æ ‡å‡† Go ä»¥éš”ç¦»ç¯å¢ƒ ---
    - name: Uninstall Standard Go from Tool Cache
      run: |
        echo "Successfully built ECH Go. Now removing standard Go to enforce environment isolation."
        sudo rm -rf /opt/hostedtoolcache/go
        echo "Standard Go tool cache cleared."
    
    - name: Validate version format
      run: |
        if ! [[ "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-ech)?$ ]]; then
          echo "Error: Version must be in format X.Y.Z or X.Y.Z-ech"
          exit 1
        fi
    
    - name: Initialize Go module and get dependencies
      run: |
        export PATH=/tmp/cf-go/bin:$PATH
        
        if [ ! -f go.mod ]; then
          go mod init proxy-client
        fi
        
        go get github.com/gorilla/websocket@latest
        go mod tidy

    # --- å…³é”®ï¼šå¼ºåˆ¶å®‰è£… Windows æ ‡å‡†åº“ (åŒ…å« ECH è¡¥ä¸) ---
    - name: Install Windows/AMD64 Standard Library with ECH patches
      run: |
        echo "Installing cross-compilation standard library for GOOS=windows, GOARCH=amd64..."
        export GOROOT="/tmp/cf-go"
        export PATH="$GOROOT/bin:$PATH"
        GOOS=windows GOARCH=amd64 go install std
        echo "Installation complete."
    # ---------------------------------------------------
    
    - name: Build for Windows AMD64 with ECH (Final Working Attempt)
      run: |
        mkdir -p ./release
        
        # å¼ºåˆ¶è®¾ç½® GOROOT å’Œ GO_CMD
        export GOROOT="/tmp/cf-go"
        GO_CMD="$GOROOT/bin/go"
        
        # --- è¯Šæ–­æ­¥éª¤ ---
        echo "--- Diagnostic Check ---"
        echo "Cloudflare GOROOT: $GOROOT"
        echo "Cloudflare Go Path: $GO_CMD"
        $GO_CMD version
        echo "--- Starting Windows AMD64 Build ---"
        
        VERSION="${{ github.event.inputs.version }}"
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT_SHA=$(git rev-parse --short HEAD)
        LDFLAGS="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.CommitSHA=${COMMIT_SHA}"
        
        # æœ€ç»ˆä¿®å¤ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„ /tmp/temp-go-cache
        echo "Building for Windows AMD64 with ECH..."
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 GOCACHE=/tmp/temp-go-cache \
          $GO_CMD build -ldflags="${LDFLAGS}" -o ./release/proxy-client-ech-windows-amd64.exe main.go
        
        chmod +x ./release/proxy-client-ech-*
        ls -lh ./release/
    
    - name: Generate checksums
      run: |
        cd ./release
        sha256sum * > checksums.txt
        cat checksums.txt
    
    - name: Create compressed archives
      run: |
        cd ./release
        zip proxy-client-ech-windows-amd64.zip proxy-client-ech-windows-amd64.exe
        
        ls -lh *.zip
    
    - name: Generate release notes
      run: |
        cat << EOF > release_notes.md
        ## Release v${{ github.event.inputs.version }} âœ¨ ECH æ”¯æŒç‰ˆæœ¬
        
        ### ğŸ”’ ç‰¹æ€§
        æ­¤ç‰ˆæœ¬ä½¿ç”¨ **Cloudflare Go** ç¼–è¯‘ï¼Œ**å®Œæ•´æ”¯æŒ ECH (Encrypted Client Hello)**ã€‚
        
        ### æ„å»ºä¿¡æ¯
        - **æäº¤ç‰ˆæœ¬**: \`$(git rev-parse --short HEAD)\`
        - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Go ç‰ˆæœ¬**: Cloudflare Go (ECH enabled)
        
        ### ä¸‹è½½
        
        #### Windows
        - **AMD64**: \`proxy-client-ech-windows-amd64.zip\`
        
        ### ä½¿ç”¨è¯´æ˜
        
        \`\`\`powershell
        # ç¤ºä¾‹ï¼šå¯åŠ¨ä»£ç†ï¼ˆWindowsï¼‰
        .\proxy-client-ech-windows-amd64.exe `
          -l 127.0.0.1:1080 `
          -f your-worker.workers.dev:443 `
          -token your-token `
          -dns https://1.1.1.1/dns-query `
          -ech cloudflare-ech.com
        \`\`\`
        EOF
        
        cat release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: Release v${{ github.event.inputs.version }} (ECH Support)
        tag_name: v${{ github.event.inputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ./release/*.zip
          ./release/checksums.txt
        make_latest: false
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-ech-v${{ github.event.inputs.version }}
        path: ./release/
        retention-days: 30
