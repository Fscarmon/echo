name: Build and Release (ECH Support)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0-ech)'
        required: true
        default: '1.0.0-ech'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential
    
    # --- ç¼“å­˜ 1: Go æ¨¡å—å’Œæ„å»ºç¼“å­˜ ---
    - name: Cache Go modules and build cache
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-mod-v1
        restore-keys: |
          ${{ runner.os }}-go-mod-

    # --- ç¼“å­˜ 2: Cloudflare Go ç¼–è¯‘å™¨ ---
    - name: Cache Cloudflare Go Toolchain
      id: cache-cf-go
      uses: actions/cache@v4
      with:
        path: /tmp/cf-go
        # Key åŒ…å« OS å’Œæ‰‹åŠ¨ç‰ˆæœ¬å·ã€‚å¦‚æœ Cloudflare Go æ›´æ–°ï¼Œè¯·ä¿®æ”¹ v1
        key: cf-go-toolchain-${{ runner.os }}-v1
        restore-keys: |
          cf-go-toolchain-${{ runner.os }}-

    - name: Clone and build Cloudflare Go
      # ä»…å½“æ²¡æœ‰ç¼“å­˜å‘½ä¸­æ—¶æ‰æ‰§è¡Œç¼–è¯‘æ­¥éª¤
      if: steps.cache-cf-go.outputs.cache-hit != 'true'
      run: |
        echo "Cache miss: Building Cloudflare Go from source..."
        # å…‹éš† Cloudflare Go åˆ†æ”¯
        git clone https://github.com/cloudflare/go.git /tmp/cf-go
        cd /tmp/cf-go
        
        # åˆ‡æ¢åˆ°æ”¯æŒ ECH çš„ä¸»åˆ†æ”¯ (cf)
        git checkout cf
        
        # æ„å»º Go
        cd src
        ./make.bash
    
    - name: Verify Cloudflare Go
      run: |
        # æ— è®ºæ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Œéƒ½éªŒè¯ä¸€ä¸‹æ˜¯å¦å­˜åœ¨
        if [ ! -f "/tmp/cf-go/bin/go" ]; then
          echo "Error: Cloudflare Go binary not found! Build failed or cache issue."
          exit 1
        fi
        /tmp/cf-go/bin/go version
        echo "Cloudflare Go is ready."
    
    - name: Validate version format
      run: |
        if ! [[ "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-ech)?$ ]]; then
          echo "Error: Version must be in format X.Y.Z or X.Y.Z-ech"
          exit 1
        fi
    
    - name: Initialize Go module and get dependencies
      run: |
        # ä¸º go mod tidy è®¾ç½® PATHï¼Œä»¥ä¾¿ä½¿ç”¨ ECH-enabled Go
        export PATH=/tmp/cf-go/bin:$PATH
        
        if [ ! -f go.mod ]; then
          go mod init proxy-client
        fi
        
        go get github.com/gorilla/websocket@latest
        go mod tidy
    
    - name: Build for Windows AMD64 with ECH
      run: |
        mkdir -p ./release
        
        # å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶è®¾ç½® Go å·¥å…·é“¾çš„æ ¹ç›®å½•
        export GOROOT="/tmp/cf-go"
        GO_CMD="$GOROOT/bin/go"
        
        # --- è¯Šæ–­æ­¥éª¤ (ç”¨äºéªŒè¯æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„ç¼–è¯‘å™¨) ---
        echo "--- Diagnostic Check ---"
        echo "Cloudflare GOROOT: $GOROOT"
        echo "Cloudflare Go Path: $GO_CMD"
        $GO_CMD version
        echo "--- Starting Windows AMD64 Build ---"
        # --- è¯Šæ–­æ­¥éª¤ç»“æŸ ---
        
        VERSION="${{ github.event.inputs.version }}"
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT_SHA=$(git rev-parse --short HEAD)
        LDFLAGS="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.CommitSHA=${COMMIT_SHA}"
        
        # å¼ºåˆ¶ä½¿ç”¨ GOROOT å’Œ GO_CMD è¿›è¡Œæ„å»º
        echo "Building for Windows AMD64 with ECH..."
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 $GO_CMD build -ldflags="${LDFLAGS}" -o ./release/proxy-client-ech-windows-amd64.exe main.go
        
        chmod +x ./release/proxy-client-ech-*
        ls -lh ./release/
    
    - name: Generate checksums
      run: |
        cd ./release
        sha256sum * > checksums.txt
        cat checksums.txt
    
    - name: Create compressed archives
      run: |
        cd ./release
        # ä»…æ‰“åŒ… Windows ç‰ˆæœ¬
        zip proxy-client-ech-windows-amd64.zip proxy-client-ech-windows-amd64.exe
        
        ls -lh *.zip
    
    - name: Generate release notes
      run: |
        cat << EOF > release_notes.md
        ## Release v${{ github.event.inputs.version }} âœ¨ ECH æ”¯æŒç‰ˆæœ¬
        
        ### ğŸ”’ ç‰¹æ€§
        æ­¤ç‰ˆæœ¬ä½¿ç”¨ **Cloudflare Go** ç¼–è¯‘ï¼Œ**å®Œæ•´æ”¯æŒ ECH (Encrypted Client Hello)**ã€‚
        
        ECH åŠŸèƒ½æä¾›ï¼š
        - âœ… åŠ å¯† TLS æ¡æ‰‹ä¸­çš„ SNI (æœåŠ¡å™¨åç§°æŒ‡ç¤º)
        - âœ… é˜²æ­¢ä¸­é—´äººç›‘æµ‹è®¿é—®çš„åŸŸå
        - âœ… å¢å¼ºéšç§ä¿æŠ¤
        
        ### æ„å»ºä¿¡æ¯
        - **æäº¤ç‰ˆæœ¬**: \`$(git rev-parse --short HEAD)\`
        - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Go ç‰ˆæœ¬**: Cloudflare Go (ECH enabled)
        
        ### ä¸‹è½½
        
        #### Windows
        - **AMD64**: \`proxy-client-ech-windows-amd64.zip\`
        
        ### ä½¿ç”¨è¯´æ˜
        
        \`\`\`powershell
        # ç¤ºä¾‹ï¼šå¯åŠ¨ä»£ç†ï¼ˆWindowsï¼‰
        .\proxy-client-ech-windows-amd64.exe `
          -l 127.0.0.1:1080 `
          -f your-worker.workers.dev:443 `
          -token your-token `
          -dns https://1.1.1.1/dns-query `
          -ech cloudflare-ech.com
        \`\`\`
        
        ### éªŒè¯ ECH æ˜¯å¦å·¥ä½œ
        è¿è¡Œç¨‹åºåï¼Œä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—ï¼š
        \`\`\`
        [ECH] é…ç½®å·²åŠ è½½ï¼Œé•¿åº¦: 123 å­—èŠ‚
        [ä»£ç†] æœåŠ¡å™¨å¯åŠ¨: 127.0.0.1:1080
        \`\`\`
        
        ---
        
        ğŸ’¡ **æç¤º**: å¦‚æœä¸éœ€è¦ ECH åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†ç‰ˆæœ¬ä»¥è·å¾—æ›´å°çš„äºŒè¿›åˆ¶ä½“ç§¯ã€‚
        EOF
        
        cat release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: Release v${{ github.event.inputs.version }} (ECH Support)
        tag_name: v${{ github.event.inputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ./release/*.zip
          ./release/checksums.txt
        make_latest: false
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-ech-v${{ github.event.inputs.version }}
        path: ./release/
        retention-days: 30
