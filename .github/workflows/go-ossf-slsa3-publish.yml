name: Build and Release (ECH Support)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0-ech)'
        required: true
        default: '1.0.0-ech'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential
    
    - name: Clone and build Cloudflare Go
      run: |
        # å…‹éš† Cloudflare Go åˆ†æ”¯
        git clone https://github.com/cloudflare/go.git /tmp/cf-go
        cd /tmp/cf-go
        
        # åˆ‡æ¢åˆ°æ”¯æŒ ECH çš„ä¸»åˆ†æ”¯ (cf)
        git checkout cf
        
        # æ„å»º Go
        cd src
        ./make.bash
        
        # éªŒè¯å®‰è£…
        /tmp/cf-go/bin/go version
        echo "Cloudflare Go with ECH support built successfully"
    
    - name: Validate version format
      run: |
        if ! [[ "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-ech)?$ ]]; then
          echo "Error: Version must be in format X.Y.Z or X.Y.Z-ech"
          exit 1
        fi
    
    - name: Initialize Go module and get dependencies
      run: |
        # ä¸ºäº† go mod æ“ä½œä¸´æ—¶è®¾ç½® PATHï¼Œä½†åœ¨æ„å»ºæ—¶æˆ‘ä»¬ä¼šä½¿ç”¨ç»å¯¹è·¯å¾„ä»¥é˜²ä¸‡ä¸€
        export PATH=/tmp/cf-go/bin:$PATH
        
        if [ ! -f go.mod ]; then
          go mod init proxy-client
        fi
        
        go get github.com/gorilla/websocket@latest
        go mod tidy
    
    - name: Build for Windows AMD64 with ECH
      run: |
        mkdir -p ./release
        
        # å…³é”®ä¿®å¤ï¼šæ˜¾å¼å®šä¹‰ä½¿ç”¨åˆšæ„å»ºçš„æ”¯æŒ ECH çš„ Go ç¼–è¯‘å™¨
        GO_CMD="/tmp/cf-go/bin/go"
        
        VERSION="${{ github.event.inputs.version }}"
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT_SHA=$(git rev-parse --short HEAD)
        LDFLAGS="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.CommitSHA=${COMMIT_SHA}"
        
        # Windows AMD64
        echo "Building for Windows AMD64 with ECH..."
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 ${GO_CMD} build -ldflags="${LDFLAGS}" -o ./release/proxy-client-ech-windows-amd64.exe main.go
        
        chmod +x ./release/proxy-client-ech-*
        ls -lh ./release/
    
    - name: Generate checksums
      run: |
        cd ./release
        sha256sum * > checksums.txt
        cat checksums.txt
    
    - name: Create compressed archives
      run: |
        cd ./release
        # ä»…æ‰“åŒ… Windows ç‰ˆæœ¬
        zip proxy-client-ech-windows-amd64.zip proxy-client-ech-windows-amd64.exe
        
        ls -lh *.zip
    
    - name: Generate release notes
      run: |
        cat << EOF > release_notes.md
        ## Release v${{ github.event.inputs.version }} âœ¨ ECH æ”¯æŒç‰ˆæœ¬
        
        ### ğŸ”’ ç‰¹æ€§
        æ­¤ç‰ˆæœ¬ä½¿ç”¨ **Cloudflare Go** ç¼–è¯‘ï¼Œ**å®Œæ•´æ”¯æŒ ECH (Encrypted Client Hello)**ã€‚
        
        ECH åŠŸèƒ½æä¾›ï¼š
        - âœ… åŠ å¯† TLS æ¡æ‰‹ä¸­çš„ SNI (æœåŠ¡å™¨åç§°æŒ‡ç¤º)
        - âœ… é˜²æ­¢ä¸­é—´äººç›‘æµ‹è®¿é—®çš„åŸŸå
        - âœ… å¢å¼ºéšç§ä¿æŠ¤
        
        ### æ„å»ºä¿¡æ¯
        - **æäº¤ç‰ˆæœ¬**: \`$(git rev-parse --short HEAD)\`
        - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Go ç‰ˆæœ¬**: Cloudflare Go (ECH enabled)
        
        ### ä¸‹è½½
        
        #### Windows
        - **AMD64**: \`proxy-client-ech-windows-amd64.zip\`
        
        ### ä½¿ç”¨è¯´æ˜
        
        \`\`\`bash
        # ç¤ºä¾‹ï¼šå¯åŠ¨ä»£ç†ï¼ˆè‡ªåŠ¨ä½¿ç”¨ ECHï¼‰
        proxy-client-ech-windows-amd64.exe ^
          -l 127.0.0.1:1080 ^
          -f your-worker.workers.dev:443 ^
          -token your-token ^
          -dns https://1.1.1.1/dns-query ^
          -ech cloudflare-ech.com
        \`\`\`
        
        ### éªŒè¯ ECH æ˜¯å¦å·¥ä½œ
        è¿è¡Œç¨‹åºåï¼Œä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—ï¼š
        \`\`\`
        [ECH] é…ç½®å·²åŠ è½½ï¼Œé•¿åº¦: 123 å­—èŠ‚
        [ä»£ç†] æœåŠ¡å™¨å¯åŠ¨: 127.0.0.1:1080
        \`\`\`
        
        ---
        
        ğŸ’¡ **æç¤º**: å¦‚æœä¸éœ€è¦ ECH åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†ç‰ˆæœ¬ä»¥è·å¾—æ›´å°çš„äºŒè¿›åˆ¶ä½“ç§¯ã€‚
        EOF
        
        cat release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: Release v${{ github.event.inputs.version }} (ECH Support)
        tag_name: v${{ github.event.inputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ./release/*.zip
          ./release/checksums.txt
        make_latest: false
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-ech-v${{ github.event.inputs.version }}
        path: ./release/
        retention-days: 30
